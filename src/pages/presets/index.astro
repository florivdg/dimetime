---
import Layout from '@/layouts/Layout.astro'
import Dashboard from '@/components/Dashboard.vue'
import PresetManager from '@/components/presets/PresetManager.vue'
import { getPresets } from '@/lib/presets'
import { getAllCategories } from '@/lib/categories'
import { getSidebarPlans } from '@/lib/plans'
import { getPlanDisplayName } from '@/lib/format'

const userId = Astro.locals.user?.id
if (!userId) {
  return Astro.redirect('/login')
}

// Fetch initial data
const presetsData = await getPresets(userId, {
  page: 1,
  limit: 20,
  includeExpired: false,
})
const categories = await getAllCategories()

// Sidebar plan items
const { currentMonth, latest } = await getSidebarPlans()
const planItems: { title: string; url: string }[] = []
if (currentMonth) {
  planItems.push({
    title: getPlanDisplayName(currentMonth.name, currentMonth.date),
    url: `/plans/${currentMonth.id}`,
  })
}
if (latest && latest.id !== currentMonth?.id) {
  planItems.push({
    title: getPlanDisplayName(latest.name, latest.date),
    url: `/plans/${latest.id}`,
  })
}
---

<Layout>
  <Dashboard
    client:load
    currentPath={Astro.url.pathname}
    breadcrumbs={[{ label: 'Vorlagen' }]}
    planItems={planItems}
  >
    <div class="flex flex-1 flex-col gap-4">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-semibold tracking-tight">
          Transaktionsvorlagen
        </h1>
      </div>
      <PresetManager
        client:load
        initialPresets={presetsData.presets}
        initialPagination={presetsData.pagination}
        categories={categories}
      />
    </div>
  </Dashboard>
</Layout>
